Description: fix tiff reader to handle TIFFTAG_SAMPLESPERPIXEL for grayscale images
 This commit fixes reading a .tiff file from ImageMagick which reports
 the following:
 TIFFTAG_BITSPERSAMPLE = 8
 TIFFTAG_SAMPLESPERPIXEL = 2
 TIFFTAG_PHOTOMETRIC = PHOTOMETRIC_MINISBLACK
 The reader uses QImage::Format_Indexed8, but since the samples per pixel
 value this should be (non-existent) QImage::Format_Indexed16, causing
 memory corruption. The fix falls back to the "normal" way of reading
 tiff images.
 .
 This patch was backported by Lisandro Damián Nicanor Pérez Meyer
 <lisandro@debian.org>
Origin: backport, commit:cb6380beb81ab9571c547270c144988781fed465
Author: L. Lunak <l.lunak@suse.cz>

--- a/src/plugins/imageformats/tiff/qtiffhandler.cpp
+++ b/src/plugins/imageformats/tiff/qtiffhandler.cpp
@@ -197,8 +197,12 @@ bool QTiffHandler::read(QImage *image)
     if (!TIFFGetField(tiff, TIFFTAG_BITSPERSAMPLE, &bitPerSample))
         bitPerSample = 1;
 
+    uint16 samplesPerPixel; // they may be e.g. grayscale with 2 samples per pixel
+    if (!TIFFGetField(tiff, TIFFTAG_SAMPLESPERPIXEL, &samplesPerPixel))
+        samplesPerPixel = 1;
+
     bool grayscale = photometric == PHOTOMETRIC_MINISBLACK || photometric == PHOTOMETRIC_MINISWHITE;
-    if (grayscale && bitPerSample == 1) {
+    if (grayscale && bitPerSample == 1 && samplesPerPixel == 1) {
         if (image->size() != QSize(width, height) || image->format() != QImage::Format_Mono)
             *image = QImage(width, height, QImage::Format_Mono);
         QVector<QRgb> colortable(2);
@@ -220,7 +224,7 @@ bool QTiffHandler::read(QImage *image)
             }
         }
     } else {
-        if ((grayscale || photometric == PHOTOMETRIC_PALETTE) && bitPerSample == 8) {
+        if ((grayscale || photometric == PHOTOMETRIC_PALETTE) && bitPerSample == 8 && samplesPerPixel == 1) {
             if (image->size() != QSize(width, height) || image->format() != QImage::Format_Indexed8)
                 *image = QImage(width, height, QImage::Format_Indexed8);
             if (!image->isNull()) {
